<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0A0A0A">
    <title>One Shot - „ÉØ„É≥„Ç∑„Éß„ÉÉ„Éà</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0A0A0A;
            --bg-secondary: #151515;
            --bg-card: #1A1A1A;
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0A0;
            --text-muted: #606060;
            --accent: #8B0000;
            /* „Éû„ÉÉ„Éà„Å™Ê∑±Á¥Ö */
            --accent-glow: rgba(139, 0, 0, 0.3);
            --success: #4CAF50;
            --warning: #FF9800;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-primary);
            line-height: 1.4;
        }

        #app {
            max-width: 480px;
            width: 100%;
            height: 100%;
            margin: 0 auto;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .screen {
            display: none;
            flex-direction: column;
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .screen.active {
            display: flex;
        }

        .screen-scrollable {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* ===== Tab Bar ===== */
        .tab-bar {
            display: flex;
            background: var(--bg-secondary);
            border-top: 1px solid var(--glass-border);
            padding: 0.5rem 1rem;
            padding-bottom: calc(0.5rem + var(--safe-bottom));
            flex-shrink: 0;
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.7rem;
            font-family: inherit;
            cursor: pointer;
            transition: color 0.2s;
        }

        .tab-item.active {
            color: var(--text-primary);
        }

        .tab-icon {
            font-size: 1.5rem;
        }

        .tab-label {
            font-weight: 600;
        }

        /* ===== Onboarding ===== */
        #onboarding {
            padding: 2rem 1.5rem;
            justify-content: center;
            background: var(--bg-primary);
            overflow-y: auto;
        }

        .onboarding-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .onboarding-header h1 {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
        }

        .onboarding-header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: var(--accent);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .notification-times {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .time-chip {
            flex: 1;
            min-width: 80px;
            padding: 0.75rem 1rem;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: 600;
        }

        .time-chip.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .time-chip input {
            background: transparent;
            border: none;
            color: inherit;
            font-size: inherit;
            font-family: inherit;
            text-align: center;
            width: 100%;
            outline: none;
            font-weight: 600;
        }

        /* ===== Buttons ===== */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            border: none;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .btn-secondary {
            background: var(--glass);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }

        /* ===== Home Screen ===== */
        #home {
            display: flex;
            flex-direction: column;
        }

        .home-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            padding-top: calc(1.5rem + var(--safe-top));
        }

        .home-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .home-title {
            font-size: 1.5rem;
            font-weight: 900;
            letter-spacing: -0.02em;
        }

        .settings-btn {
            width: 44px;
            height: 44px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .streak-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .streak-count {
            font-size: 7rem;
            font-weight: 900;
            line-height: 1;
            letter-spacing: -0.05em;
        }

        .streak-label {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .goal-display {
            text-align: center;
            margin-bottom: 2rem;
        }

        .goal-text {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .info-row {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .info-item {
            text-align: center;
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: 900;
        }

        .info-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 600;
            margin-top: 0.25rem;
        }

        .record-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .record-btn-large {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 0 30px var(--accent-glow);
        }

        .record-btn-large:active {
            transform: scale(0.95);
        }

        .camera-icon {
            width: 60px;
            height: 60px;
            fill: white;
        }

        /* ===== Camera Screen ===== */
        #camera {
            background: #000;
        }

        #video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay-ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1.5rem;
            padding-top: calc(1.5rem + var(--safe-top));
            padding-bottom: calc(2rem + var(--safe-bottom));
            pointer-events: none;
        }

        .camera-top {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .camera-timer {
            font-size: 3rem;
            font-weight: 900;
            color: white;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
        }

        .camera-capture-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            border: 4px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .camera-capture-btn.recording {
            background: var(--accent);
        }

        .camera-capture-btn.recording::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 4px;
        }

        /* ===== Preview Screen ===== */
        #preview {
            background: #000;
        }

        #preview-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 1rem;
            padding: 2rem;
            padding-bottom: calc(2rem + var(--safe-bottom));
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        }

        .preview-controls .btn {
            flex: 1;
        }

        /* ===== Calendar Screen ===== */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            padding-bottom: 0;
        }

        .calendar-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-nav-btn {
            width: 36px;
            height: 36px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 0 1.5rem;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            padding: 0.5rem 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
        }

        .calendar-day.today {
            border-color: var(--accent);
            color: var(--accent);
        }

        .calendar-day.recorded {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .calendar-day-num {
            font-weight: 600;
        }

        /* ===== Video Modal ===== */
        .video-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .video-modal.active {
            display: flex;
        }

        .video-modal-close {
            position: absolute;
            top: calc(1rem + var(--safe-top));
            right: 1rem;
            width: 44px;
            height: 44px;
            background: var(--glass);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 101;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-modal video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ===== Settings ===== */
        #settings {
            padding: 1.5rem;
            padding-top: calc(1.5rem + var(--safe-top));
            overflow-y: auto;
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .settings-back {
            width: 44px;
            height: 44px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            margin-bottom: 0.5rem;
        }

        .settings-item-label {
            font-size: 1rem;
            font-weight: 500;
        }

        .settings-item input[type="text"] {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            text-align: right;
            outline: none;
            font-weight: 600;
        }

        .danger-btn {
            width: 100%;
            padding: 1rem;
            background: var(--glass);
            border: 1px solid var(--accent);
            border-radius: 12px;
            color: var(--accent);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* ===== Animations ===== */
        @keyframes recording-pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(139, 0, 0, 0.5);
            }

            50% {
                box-shadow: 0 0 0 20px transparent;
            }
        }

        .recording .camera-capture-btn {
            animation: recording-pulse 1s infinite;
        }

        #composite-canvas {
            display: none;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="onboarding" class="screen active">
            <div class="onboarding-header">
                <h1>One Shot</h1>
                <p>ÊàêÂäü„Åæ„Åß„ÅÆ1„Ç≥„Éû„Çí5Áßí„ÅßË®òÈå≤</p>
            </div>
            <div class="form-group">
                <label>ÁøíÊÖ£„Å´„Åó„Åü„ÅÑÁõÆÊ®ô</label>
                <input type="text" class="form-input" id="goal-input" placeholder="‰æã: # ÊØéÊó•Á≠ã„Éà„É¨">
            </div>
            <div class="form-group">
                <label>ÈÄöÁü•„Çø„Ç§„Éü„É≥„Ç∞ (‰ªªÊÑè)</label>
                <div class="notification-times">
                    <div class="time-chip" data-time="morning"><span>Êúù</span></div>
                    <div class="time-chip" data-time="evening"><span>Â§ú</span></div>
                </div>
            </div>
            <button class="btn btn-primary" id="start-btn" style="margin-top: 2rem; width: 100%;">„ÅØ„Åò„ÇÅ„Çã</button>
        </div>

        <div id="home" class="screen">
            <div class="home-content">
                <div class="home-header">
                    <div class="home-title">One Shot</div>
                    <button class="settings-btn" id="settings-open-btn">‚öôÔ∏è</button>
                </div>
                <div class="streak-container">
                    <div class="streak-count" id="streak-display">0</div>
                    <div class="streak-label">DAYS STREAK</div>
                </div>
                <div class="goal-display">
                    <div class="goal-text" id="goal-display"></div>
                </div>
                <div class="info-row">
                    <div class="info-item">
                        <div class="info-value" id="pass-count">0</div>
                        <div class="info-label">PASSES</div>
                    </div>
                    <div class="info-item">
                        <div class="info-value" id="today-status">Êú™</div>
                        <div class="info-label">TODAY</div>
                    </div>
                </div>
                <div class="record-section">
                    <button class="record-btn-large" id="record-start-btn">
                        <svg class="camera-icon" viewBox="0 0 24 24">
                            <path
                                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="camera" class="screen">
            <video id="video-preview" autoplay playsinline muted></video>
            <div class="camera-overlay-ui" id="camera-ui">
                <div class="camera-top">
                    <div class="camera-timer" id="camera-timer"></div>
                </div>
                <div class="camera-controls">
                    <button class="camera-capture-btn" id="camera-capture-btn"></button>
                </div>
            </div>
        </div>

        <div id="preview" class="screen">
            <video id="preview-video" autoplay loop playsinline></video>
            <div class="preview-controls">
                <button class="btn btn-secondary" id="retake-btn">ÊíÆ„ÇäÁõ¥„Åô</button>
                <button class="btn btn-primary" id="save-btn">‰øùÂ≠ò„Åô„Çã</button>
            </div>
        </div>

        <div id="calendar-screen" class="screen">
            <div class="screen-scrollable">
                <div class="calendar-header">
                    <div class="calendar-title" id="calendar-title"></div>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="cal-prev">‚óÄ</button>
                        <button class="calendar-nav-btn" id="cal-next">‚ñ∂</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
                <div style="padding: 1.5rem; text-align: center; color: var(--text-muted); font-size: 0.9rem;">
                    „Çø„ÉÉ„Éó„Åó„Å¶ÂãïÁîª„ÇíÂÜçÁîü
                </div>
            </div>
        </div>

        <div id="settings" class="screen">
            <div class="settings-header">
                <button class="settings-back" id="settings-back-btn">‚Üê</button>
                <div class="settings-title">Ë®≠ÂÆö</div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">ÁõÆÊ®ô</div>
                <div class="settings-item">
                    <span class="settings-item-label">ÁõÆÊ®ôÂêç</span>
                    <input type="text" id="settings-goal" value="">
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">„Éá„Éº„Çø</div>
                <button class="danger-btn" id="reset-data-btn">„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà</button>
            </div>
        </div>

        <div class="video-modal" id="video-modal">
            <button class="video-modal-close" id="modal-close-btn">‚úï</button>
            <video id="modal-video" controls playsinline></video>
        </div>

        <div class="tab-bar" id="main-tab-bar">
            <button class="tab-item active" data-screen="home"><span class="tab-icon">‚óè</span><span
                    class="tab-label">Today</span></button>
            <button class="tab-item" data-screen="calendar-screen"><span class="tab-icon">üìÖ</span><span
                    class="tab-label">History</span></button>
        </div>
    </div>

    <canvas id="composite-canvas"></canvas>

    <script>
        // ===== Constants & Utils =====
        const CANVAS_W = 1080;
        const CANVAS_H = 1920;
        const DB_NAME = 'OneShotDB_v2';
        const DB_VERSION = 1;

        // 3AM cutoff logic
        function getLogicalDate(date = new Date()) {
            const d = new Date(date);
            if (d.getHours() < 3) d.setDate(d.getDate() - 1);
            return d.toISOString().split('T')[0];
        }

        function formatDateForOverlay(date = new Date()) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const h = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            return { date: `${y}.${m}.${d}`, time: `${h}:${min}` };
        }

        // ===== App State =====
        const APP = {
            goal: '', streak: 0, passes: 0, lastRecordDate: null, lastPassGrant: null,
            records: {}, // { 'YYYY-MM-DD': { blob: Blob, timestamp: number } }
            videoStream: null, canvasProcessor: null, mediaRecorder: null, recordedChunks: [],
            currentCalendarDate: new Date()
        };

        // ===== CanvasProcessor (9:16 Center Crop + Filter + Large Overlays) =====
        class CanvasProcessor {
            constructor(videoElement, canvasElement) {
                this.video = videoElement;
                this.canvas = canvasElement;
                this.ctx = canvasElement.getContext('2d', { willReadFrequently: false });
                this.canvas.width = CANVAS_W;
                this.canvas.height = CANVAS_H;
                this.isActive = false;
                this.startTime = 0;
                this.frozenFrame = null;
                this.animationFrameId = null;
            }

            start() {
                this.isActive = true;
                this.startTime = Date.now();
                this.frozenFrame = null;
                this._loop();
            }

            stop() {
                this.isActive = false;
                if (this.animationFrameId) cancelAnimationFrame(this.animationFrameId);
            }

            _drawVideoCenterCrop(ctx, video, cw, ch) {
                const vw = video.videoWidth;
                const vh = video.videoHeight;
                if (!vw || !vh) return;
                const videoRatio = vw / vh;
                const canvasRatio = cw / ch;
                let sx, sy, sw, sh;
                if (videoRatio > canvasRatio) {
                    sh = vh; sw = vh * canvasRatio;
                    sx = (vw - sw) / 2; sy = 0;
                } else {
                    sw = vw; sh = vw / canvasRatio;
                    sx = 0; sy = (vh - sh) / 2;
                }
                ctx.drawImage(video, sx, sy, sw, sh, 0, 0, cw, ch);
            }

            _loop() {
                if (!this.isActive) return;
                const elapsed = Date.now() - this.startTime;
                const ctx = this.ctx;
                const w = CANVAS_W; const h = CANVAS_H;

                if (elapsed < 3000) {
                    // Phase 1: Live
                    ctx.filter = 'none';
                    this._drawVideoCenterCrop(ctx, this.video, w, h);
                } else {
                    // Phase 2: Frozen + Filter
                    if (!this.frozenFrame) {
                        this.frozenFrame = document.createElement('canvas');
                        this.frozenFrame.width = w; this.frozenFrame.height = h;
                        const fCtx = this.frozenFrame.getContext('2d');
                        this._drawVideoCenterCrop(fCtx, this.video, w, h);
                    }
                    // Apply Filter
                    ctx.filter = 'brightness(0.7) contrast(1.3) saturate(0.6)';
                    ctx.drawImage(this.frozenFrame, 0, 0, w, h);
                    ctx.filter = 'none';
                    // Draw Overlays
                    this._drawOverlays(ctx, w, h);
                }
                this.animationFrameId = requestAnimationFrame(() => this._loop());
            }

            _drawOverlays(ctx, w, h) {
                // Large Padding for SNS UI avoidance
                const padX = Math.round(w * 0.12);
                const padYTop = Math.round(h * 0.1);
                const padYBottom = Math.round(h * 0.2);

                const rSize = Math.round(w * 0.08);
                const rThick = Math.round(w * 0.006);

                // 1. Gradient
                const gradH = h * 0.5;
                const grad = ctx.createLinearGradient(0, h - gradH, 0, h);
                grad.addColorStop(0, 'rgba(0,0,0,0)');
                grad.addColorStop(1, 'rgba(0,0,0,0.9)');
                ctx.fillStyle = grad;
                ctx.fillRect(0, h - gradH, w, gradH);

                // 2. Reticles (White)
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = rThick;
                ctx.beginPath();
                // TL
                ctx.moveTo(padX, padYTop + rSize); ctx.lineTo(padX, padYTop); ctx.lineTo(padX + rSize, padYTop);
                // TR
                ctx.moveTo(w - padX - rSize, padYTop); ctx.lineTo(w - padX, padYTop); ctx.lineTo(w - padX, padYTop + rSize);
                // BR
                ctx.moveTo(w - padX, h - padYBottom - rSize); ctx.lineTo(w - padX, h - padYBottom); ctx.lineTo(w - padX - rSize, h - padYBottom);
                // BL
                ctx.moveTo(padX + rSize, h - padYBottom); ctx.lineTo(padX, h - padYBottom); ctx.lineTo(padX, h - padYBottom - rSize);
                ctx.stroke();

                // 3. Text (Large & Bold)
                const dayStr = `DAY ${APP.streak + 1}`;
                const { date, time } = formatDateForOverlay();
                const goalStr = APP.goal || '';

                ctx.fillStyle = '#FFFFFF';
                ctx.shadowColor = 'rgba(0,0,0,1.0)';
                ctx.shadowBlur = 20;
                ctx.shadowOffsetY = 4;

                // DAY (Top Left, Huge)
                const lgFont = Math.floor(w * 0.18);
                ctx.font = `900 ${lgFont}px Inter, sans-serif`;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                ctx.fillText(dayStr, padX + rThick * 2, padYTop + rThick * 2);

                // Date (Top Right, Large)
                const smFont = Math.floor(w * 0.06);
                ctx.font = `600 ${smFont}px Inter, sans-serif`;
                ctx.textAlign = 'right';
                ctx.fillText(date, w - padX - rThick * 2, padYTop + rThick * 2);
                ctx.fillText(time, w - padX - rThick * 2, padYTop + rThick * 2 + smFont * 1.4);

                // Goal (Bottom Center, Large)
                const mdFont = Math.floor(w * 0.1);
                ctx.font = `700 ${mdFont}px Inter, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.fillText(goalStr, w / 2, h - padYBottom - rThick * 2);

                ctx.shadowColor = 'transparent';
            }
        }

        // ===== IndexedDB & State =====
        let db = null;
        async function initDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => { db = req.result; resolve(db); };
                req.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains('videos')) d.createObjectStore('videos');
                };
            });
        }

        async function saveVideo(dateKey, blob) {
            if (!db) throw new Error('DB not ready');
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['videos'], 'readwrite');
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
                tx.objectStore('videos').put(blob, dateKey);
            });
        }

        async function loadRecords() {
            if (!db) return;
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['videos'], 'readonly');
                const req = tx.objectStore('videos').getAllKeys();
                req.onsuccess = () => {
                    APP.records = {};
                    req.result.forEach(key => APP.records[key] = { blob: true });
                    resolve();
                };
                req.onerror = () => reject(req.error);
            });
        }

        async function getVideo(dateKey) {
            if (!db) return null;
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['videos'], 'readonly');
                const req = tx.objectStore('videos').get(dateKey);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        function loadAppState() {
            const saved = localStorage.getItem('oneshot_state_v2');
            if (saved) {
                const d = JSON.parse(saved);
                APP.goal = d.goal || '';
                APP.passes = d.passes || 0;
                APP.lastRecordDate = d.lastRecordDate;
                APP.lastPassGrant = d.lastPassGrant;
            }
        }

        function saveAppState() {
            localStorage.setItem('oneshot_state_v2', JSON.stringify({
                goal: APP.goal, passes: APP.passes, lastRecordDate: APP.lastRecordDate, lastPassGrant: APP.lastPassGrant
            }));
        }

        function calculateStreak() {
            const today = getLogicalDate();
            let streak = 0, check = new Date();
            if (getLogicalDate(check) !== today) check.setDate(check.getDate() - 1);
            while (true) {
                const key = getLogicalDate(check);
                if (APP.records[key]) { streak++; check.setDate(check.getDate() - 1); }
                else break;
            }
            APP.streak = streak;
        }

        function checkPassGrant() {
            const today = new Date();
            if (today.getDay() === 1 && getLogicalDate(today) !== APP.lastPassGrant) {
                APP.passes++; APP.lastPassGrant = getLogicalDate(today); saveAppState();
            }
        }

        // ===== UI & Flows =====
        function updateHomeUI() {
            calculateStreak();
            document.getElementById('streak-display').textContent = APP.streak;
            document.getElementById('goal-display').textContent = APP.goal;
            document.getElementById('pass-count').textContent = APP.passes;
            const todayKey = getLogicalDate();
            document.getElementById('today-status').textContent = APP.records[todayKey] ? 'Ê∏à' : 'Êú™';
            document.getElementById('today-status').style.color = APP.records[todayKey] ? 'var(--success)' : 'var(--text-secondary)';
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const tabBar = document.getElementById('main-tab-bar');
            tabBar.style.display = ['home', 'calendar-screen'].includes(id) ? 'flex' : 'none';
            if (id === 'home') updateHomeUI();
            if (id === 'calendar-screen') renderCalendar();
        }

        // Camera Flow
        async function startCameraFlow() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1080 }, height: { ideal: 1920 }, aspectRatio: { ideal: 9 / 16 } },
                    audio: true
                });
                APP.videoStream = stream;
                const video = document.getElementById('video-preview');
                video.srcObject = stream;
                const canvas = document.getElementById('composite-canvas');
                APP.canvasProcessor = new CanvasProcessor(video, canvas);
                showScreen('camera');
                document.getElementById('camera-ui').style.display = 'flex';
            } catch (e) {
                alert('„Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message);
            }
        }

        function startRecording() {
            if (!APP.videoStream || !APP.canvasProcessor) return;
            const btn = document.getElementById('camera-capture-btn');
            if (btn.classList.contains('recording')) return;
            btn.classList.add('recording');
            document.getElementById('camera-ui').style.display = 'none'; // Hide UI during recording

            APP.canvasProcessor.start();
            const canvasStream = document.getElementById('composite-canvas').captureStream(30);
            APP.videoStream.getAudioTracks().forEach(t => canvasStream.addTrack(t));
            APP.recordedChunks = [];
            // Safari friendly mimeType
            let options = { mimeType: 'video/mp4' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/webm' };
            
            APP.mediaRecorder = new MediaRecorder(canvasStream, options);
            APP.mediaRecorder.ondataavailable = e => { if (e.data.size > 0) APP.recordedChunks.push(e.data); };
            APP.mediaRecorder.onstop = () => {
                const blob = new Blob(APP.recordedChunks, { type: APP.mediaRecorder.mimeType });
                showPreview(blob);
            };
            APP.mediaRecorder.start();

            let count = 3;
            const timer = document.getElementById('camera-timer');
            document.getElementById('camera-ui').style.display = 'flex'; // Show Timer
            timer.textContent = count;
            const int = setInterval(() => {
                count--;
                if (count > 0) timer.textContent = count;
                else {
                    clearInterval(int);
                    timer.textContent = '';
                    setTimeout(() => {
                        APP.mediaRecorder.stop();
                        APP.canvasProcessor.stop();
                        APP.videoStream.getTracks().forEach(t => t.stop());
                    }, 2000); // 2s freeze
                }
            }, 1000);
        }

        function showPreview(blob) {
            const video = document.getElementById('preview-video');
            video.src = URL.createObjectURL(blob);
            video.currentBlob = blob;
            showScreen('preview');
        }

        async function saveRecording() {
            const blob = document.getElementById('preview-video').currentBlob;
            if (!blob) return;
            const todayKey = getLogicalDate();
            try {
                await saveVideo(todayKey, blob);
                APP.records[todayKey] = { blob: true };
                APP.lastRecordDate = todayKey;
                saveAppState();
                updateHomeUI();
                showScreen('home');
            } catch (e) {
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message);
            }
        }

        // Calendar
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const d = APP.currentCalendarDate;
            const year = d.getFullYear(), month = d.getMonth();
            document.getElementById('calendar-title').textContent = `${year}Âπ¥ ${month + 1}Êúà`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let html = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'].map(n => `<div class="calendar-day-header">${n}</div>`).join('');
            for (let i = 0; i < firstDay; i++) html += '<div class="calendar-day" style="visibility:hidden"></div>';
            const todayKey = getLogicalDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let cls = 'calendar-day';
                if (dateKey === todayKey) cls += ' today';
                if (APP.records[dateKey]) cls += ' recorded';
                html += `<div class="${cls}" data-key="${dateKey}"><span class="calendar-day-num">${day}</span></div>`;
            }
            grid.innerHTML = html;
            grid.querySelectorAll('.calendar-day.recorded').forEach(el => {
                el.addEventListener('click', async () => {
                    const blob = await getVideo(el.dataset.key);
                    if (blob) {
                        const v = document.getElementById('modal-video');
                        v.src = URL.createObjectURL(blob);
                        document.getElementById('video-modal').classList.add('active');
                        v.play();
                    }
                });
            });
        }

        // Init
        async function init() {
            try { await initDB(); await loadRecords(); } catch (e) { console.error(e); }
            loadAppState(); checkPassGrant();
            
            // Event Listeners
            document.getElementById('start-btn').addEventListener('click', () => {
                APP.goal = document.getElementById('goal-input').value;
                if (!APP.goal) return alert('ÁõÆÊ®ô„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                saveAppState(); showScreen('home');
            });
            document.getElementById('record-start-btn').addEventListener('click', startCameraFlow);
            document.getElementById('camera-capture-btn').addEventListener('click', startRecording);
            document.getElementById('save-btn').addEventListener('click', saveRecording);
            document.getElementById('retake-btn').addEventListener('click', () => startCameraFlow());
            document.getElementById('settings-open-btn').addEventListener('click', () => {
                document.getElementById('settings-goal').value = APP.goal;
                showScreen('settings');
            });
            document.getElementById('settings-back-btn').addEventListener('click', () => {
                APP.goal = document.getElementById('settings-goal').value;
                saveAppState(); showScreen('home');
            });
            document.getElementById('reset-data-btn').addEventListener('click', () => {
                if(confirm('Êú¨ÂΩì„Å´„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                    localStorage.removeItem('oneshot_state_v2');
                    indexedDB.deleteDatabase(DB_NAME);
                    location.reload();
                }
            });
            document.getElementById('cal-prev').addEventListener('click', () => { APP.currentCalendarDate.setMonth(APP.currentCalendarDate.getMonth() - 1); renderCalendar(); });
            document.getElementById('cal-next').addEventListener('click', () => { APP.currentCalendarDate.setMonth(APP.currentCalendarDate.getMonth() + 1); renderCalendar(); });
            document.getElementById('modal-close-btn').addEventListener('click', () => {
                document.getElementById('video-modal').classList.remove('active');
                document.getElementById('modal-video').pause();
            });
            document.querySelectorAll('.tab-item').forEach(t => t.addEventListener('click', () => showScreen(t.dataset.screen)));

            if (APP.goal) showScreen('home'); else showScreen('onboarding');
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
